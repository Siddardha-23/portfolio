# =============================================================================
# Bitbucket Pipelines - Portfolio Deployment to AWS
# =============================================================================
# Architecture: S3 + CloudFront + Lambda + API Gateway
# Domain: manneharshithsiddardha.com
#
# SECRETS MANAGEMENT:
# - Application secrets (MongoDB URI, JWT, etc.) are stored in AWS SSM Parameter Store
# - Only AWS credentials and resource names are needed in Bitbucket Variables
#
# Required Bitbucket Repository Variables:
# - AWS_ACCESS_KEY_ID (secured)
# - AWS_SECRET_ACCESS_KEY (secured)
# - S3_BUCKET_NAME
# - CLOUDFRONT_DISTRIBUTION_ID
# - LAMBDA_FUNCTION_NAME
# - DOMAIN_NAME
#
# Optional (only for Terraform - first-time infrastructure setup):
# - MONGODB_URI (secured) - stored in SSM after first deploy
# - JWT_SECRET_KEY (secured) - stored in SSM after first deploy
# - IPINFO_TOKEN (secured) - stored in SSM after first deploy
# =============================================================================

image: atlassian/default-image:4

definitions:
  caches:
    npm-frontend: portfolio-frontend/node_modules
    pip-backend: ~/.cache/pip

  steps:
    # =========================================================================
    # Frontend Build & Deploy
    # =========================================================================
    - step: &deploy-frontend
        name: ğŸŒ Deploy Frontend
        caches:
          - npm-frontend
        script:
          # Install Node.js 20
          - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          - apt-get install -y nodejs
          
          # Navigate to frontend directory
          - cd portfolio-frontend
          
          # Install dependencies
          - npm ci
          
          # Create production environment file
          - echo "VITE_API_URL=https://${DOMAIN_NAME}/api" > .env.production
          
          # Build frontend
          - npm run build
          
          # Install AWS CLI
          - pip install awscli
          
          # Deploy to S3 with cache optimization
          - |
            aws s3 sync dist/ s3://${S3_BUCKET_NAME}/ \
              --delete \
              --cache-control "public, max-age=31536000" \
              --exclude "index.html" \
              --exclude "*.json"
          
          # Upload index.html with no-cache for instant updates
          - |
            aws s3 cp dist/index.html s3://${S3_BUCKET_NAME}/index.html \
              --cache-control "no-cache, no-store, must-revalidate"
          
          # Upload JSON files with short cache
          - |
            aws s3 sync dist/ s3://${S3_BUCKET_NAME}/ \
              --exclude "*" \
              --include "*.json" \
              --cache-control "public, max-age=60"
          
          # Invalidate CloudFront cache
          - |
            aws cloudfront create-invalidation \
              --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} \
              --paths "/*"
        artifacts:
          - portfolio-frontend/dist/**

    # =========================================================================
    # Backend Build & Deploy
    # =========================================================================
    - step: &deploy-backend
        name: âš¡ Deploy Backend
        caches:
          - pip-backend
        script:
          # Install Python 3.11
          - apt-get update && apt-get install -y python3.11 python3.11-venv python3-pip zip
          
          # Navigate to backend directory
          - cd portfolio-backend
          
          # Create package directory
          - rm -rf package lambda-deployment.zip
          - mkdir -p package
          
          # Install dependencies to package directory
          - pip3 install -r requirements.txt -t ./package --upgrade
          
          # Copy application code
          - cp -r *.py package/ 2>/dev/null || true
          - cp -r blueprints models services utils package/
          
          # Create deployment zip
          - cd package && zip -r9 ../lambda-deployment.zip . && cd ..
          
          # Install AWS CLI
          - pip install awscli
          
          # Deploy to Lambda
          - |
            aws lambda update-function-code \
              --function-name ${LAMBDA_FUNCTION_NAME} \
              --zip-file fileb://lambda-deployment.zip \
              --publish
          
          # Wait for Lambda update to complete
          - aws lambda wait function-updated --function-name ${LAMBDA_FUNCTION_NAME}
          
          # Verify deployment
          - echo "Deployment complete! Testing health endpoint..."
          - curl -f https://${DOMAIN_NAME}/api/health || echo "Health check pending (CDN propagation may take a few minutes)"

    # =========================================================================
    # Infrastructure Deploy (Terraform)
    # =========================================================================
    - step: &deploy-infrastructure
        name: ğŸ—ï¸ Deploy Infrastructure
        image: hashicorp/terraform:1.6
        script:
          - cd infrastructure/terraform
          
          # Create terraform.tfvars from environment variables
          - |
            cat > terraform.tfvars <<EOF
            aws_region     = "us-east-1"
            project_name   = "portfolio"
            environment    = "prod"
            domain_name    = "${DOMAIN_NAME}"
            mongodb_uri    = "${MONGODB_URI}"
            jwt_secret_key = "${JWT_SECRET_KEY}"
            ipinfo_token   = "${IPINFO_TOKEN}"
            EOF
          
          # Initialize and apply
          - terraform init
          - terraform plan -out=tfplan
          - terraform apply -auto-approve tfplan
          
          # Output values for reference
          - terraform output

# =============================================================================
# Pipeline Definitions
# =============================================================================

pipelines:
  # ---------------------------------------------------------------------------
  # Default: Run on every push to main/master
  # ---------------------------------------------------------------------------
  branches:
    main:
      - parallel:
          - step: *deploy-frontend
          - step: *deploy-backend
    master:
      - parallel:
          - step: *deploy-frontend
          - step: *deploy-backend

  # ---------------------------------------------------------------------------
  # Custom Pipelines (Manual Trigger)
  # ---------------------------------------------------------------------------
  custom:
    # Deploy only frontend
    deploy-frontend:
      - step: *deploy-frontend
    
    # Deploy only backend
    deploy-backend:
      - step: *deploy-backend
    
    # Deploy infrastructure (Terraform)
    deploy-infrastructure:
      - step: *deploy-infrastructure
    
    # Full deployment (Infrastructure + App)
    full-deploy:
      - step: *deploy-infrastructure
      - parallel:
          - step: *deploy-frontend
          - step: *deploy-backend

  # ---------------------------------------------------------------------------
  # Pull Request: Build only, no deploy
  # ---------------------------------------------------------------------------
  pull-requests:
    '**':
      - step:
          name: ğŸ” Build & Validate
          script:
            # Frontend build check
            - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            - apt-get install -y nodejs
            - cd portfolio-frontend
            - npm ci
            - npm run build
            - npm run lint || true
            
            # Backend syntax check
            - cd ../portfolio-backend
            - pip3 install -r requirements.txt
            - python3 -m py_compile app.py lambda_handler.py
          artifacts:
            - portfolio-frontend/dist/**
